<html>
    <head>
        <style>
            /* used to hide the mathjax logo
                Its always hidden but has a length longer
                then the container.  So i have to display
                none everthing.
            */
            #MathJax_SVG_Hidden{
                display:none;
            }
            #MathJax_SVG_Hidden + svg{
                display:none;
            }
        </style>
    </head>
    <body>
    <div id="main"></div>
    <canvas id="myCanvas" width="800px" style="display:none">
                        
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js" async>
    </script>
    <script type="text/x-mathjax-config">
        // needs to be in heer or else it doesn't work 
        //common configs
        //http://docs.mathjax.org/en/latest/config-files.html
        MathJax.Hub.Config({
            jax: ["input/TeX","input/MathML","input/AsciiMath","output/SVG"],
            extensions: ["tex2jax.js","mml2jax.js","MathEvents.js","asciimath2jax.js","MathZoom.js","AssistiveMML.js"],
            MathML: {
                extensions: ["content-mathml.js"]
            },
            TeX: {
                Macros: {
                    RR: '{\\bf R}',
                    bold: ['{\\bf #1}', 1]
                }
            },
            tex2jax: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                processEscapes: true
            },
            AsciiMath: {
                fixphi: true,
                useMathMLspacing: true,
                displaystyle: false,
                decimalsign: "."
            },
            SVG: {
                //font: "STIX-Web",
                mtextFontInherit: true,
                blacker: 1,
                linebreaks: { automatic: true },
                useFontCache: false
            },
            menuSettings: {
                zoom: "Click"
            },
            MatchWebFonts: {
                matchFor: {
                    //https://github.com/electron/electron/issues/6564
                    // use fontcache off
                    SVG: {useFontCache: false}
                },
                fontCheckDelay: 500,
                fontCheckTimeout: 15 * 1000
                },
                messageStyle: "none"
            }
        );
    </script>
    <script src="./SelectInput.js"></script> 

    <script >
        var divSvmEquation = "MathTextElm";
        var node = document.getElementById('main');
        var app = Elm.Main.embed(node);
        // receive something from Elm
        app.ports.toJs.subscribe(function (str) {
            console.log("got from Elm:", str);
            var math = MathJax.Hub.getAllJax(divSvmEquation)[0];
            MathJax.Hub.Queue(["Text",math,str]);
        });
        app.ports.sumitEquation.subscribe(function(str){
            console.log("submitting equations " + str)
            getImage()
        });


        //app.ports.toElm.send("testing");
        var getImage  = function(){
            var divSvg = document.getElementById(divSvmEquation);
            console.log(divSvg)
            if(divSvg != null){
                var svg = divSvg.getElementsByTagName("svg")[0];
                var canvas = document.getElementById("myCanvas");
                drawInlineSVG(svg, function(){
                    var image = canvas.toDataURL("image/png");
                    //console.log(image)
                google.script.run.withSuccessHandler(function(){console.log("success") }).withFailureHandler(function(error){console.log("error"); console.log(error)}).setImage(image.split("base64,")[1]);
                });    
            }
        }
  
        /*
            accept a svg and will perfect construct a canvas to match
            the dimension of the svg
        */
        function drawInlineSVG(svgElement, callback){
            var svgURL = new XMLSerializer().serializeToString(svgElement);
            var canvas = document.getElementById("myCanvas");
            var ratioSvg = svgElement.clientHeight/svgElement.clientWidth;
            var heigthSvg =  canvas.width * ratioSvg;
            canvas.height = heigthSvg; //look nicer with heightSvg + heightSvg *.2
            var img  = new Image();
            img.onload = function(){                      //width // height
            canvas.getContext('2d').drawImage(this, 0,0, canvas.width, canvas.height);
            callback();
            }
            img.src = 'data:image/svg+xml; charset=utf8, '+encodeURIComponent(svgURL);
        }
  
    </script>
     
    </body>
</html>